<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>History - KisanAI Live</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="js/translations.js"></script>
    <script src="js/utils.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <button class="mobile-nav-toggle" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <i class="fas fa-leaf"></i> KisanAI <span>Live</span>
            </div>
            <ul class="sidebar-menu">
                <li><a href="dashboard.html" data-i18n="dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="scan.html" data-i18n="scan_crop"><i class="fas fa-camera"></i> Scan Crop</a></li>
                <li><a href="recommendations.html" data-i18n="recommendations"><i class="fas fa-seedling"></i> Recommendations</a></li>
                <li><a href="chat.html" data-i18n="ai_advisor"><i class="fas fa-comments"></i> AI Advisor</a></li>
                <li><a href="history.html" class="active" data-i18n="history"><i class="fas fa-history"></i> History</a></li>
                <li><a href="profile.html" data-i18n="profile"><i class="fas fa-user"></i> Profile</a></li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h1 data-i18n="scan_history">Scan History</h1>
                <div class="badge mongodb">
                    <i class="fas fa-database"></i> <span data-i18n="fetched_from_db">Fetched from MongoDB Atlas</span>
                </div>
            </div>

            <div class="history-grid" id="history-grid">
                <!-- History items will be loaded here -->
                <div style="text-align: center; width: 100%; grid-column: 1 / -1;">
                    <p data-i18n="loading_history">Loading history...</p>
                </div>
            </div>
            <footer style="text-align: center; padding: 20px; margin-top: 30px; color: #666; font-size: 0.9rem;">
                &copy; 2026 KisanAI Live. Created by Varnit Kumar.
            </footer>
        </main>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.9);">
        <span style="position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer;" onclick="closeModal()">&times;</span>
        <img class="modal-content" id="fullImage" style="margin: auto; display: block; width: 80%; max-width: 700px; margin-top: 50px;">
        <div id="caption" style="margin: auto; display: block; width: 80%; max-width: 700px; text-align: center; color: #ccc; padding: 10px 0; height: 150px;"></div>
    </div>

    <script>
        async function loadHistory() {
            const userId = localStorage.getItem('user_id');
            // If no user_id, maybe redirect or show generic message. 
            // For now, let's try to fetch what we can.
            
            try {
                const response = await fetch(`/api/history${userId ? '?user_id=' + userId : ''}`);
                const data = await response.json();

                if (data.success) {
                    const grid = document.getElementById('history-grid');
                    grid.innerHTML = ''; // Clear loading

                    if (data.history.length === 0) {
                        grid.innerHTML = '<div style="text-align: center; width: 100%; grid-column: 1 / -1;"><p data-i18n="no_history">No scan history found. Start by scanning a crop!</p></div>';
                        // Re-apply translations for dynamic content
                        applyTranslations(localStorage.getItem('language') || 'en');
                        return;
                    }

                    data.history.forEach(record => {
                        const card = document.createElement('div');
                        card.className = 'history-card';
                        
                        // Use a default image if not provided
                        const imgSrc = record.image_path || 'images/1.jpg'; // Adjust path logic if needed
                        
                        let displayImgSrc = imgSrc;
                        if (!imgSrc.startsWith('http') && !imgSrc.startsWith('images/')) {
                             // Assuming it might be a filename in uploads
                             displayImgSrc = 'uploads/' + imgSrc.split('/').pop();
                        }

                        card.innerHTML = `
                            <img src="${displayImgSrc}" alt="${record.disease || 'Crop'}" class="history-img" onclick="openModal('${displayImgSrc}', '${record.disease || 'Analysis Result'}')">
                            <div class="history-content">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <h3 style="font-size: 1.1rem;">${record.disease || 'Unknown Issue'}</h3>
                                    <span style="font-size: 0.8rem; color: #888;">${new Date(record.created_at || Date.now()).toLocaleDateString()}</span>
                                </div>
                                <p style="font-size: 0.9rem; color: #666;" data-i18n="confidence_score">Confidence Score</p>
                                <div class="confidence-meter">
                                    <div class="confidence-fill" style="width: ${record.confidence || 0}%;"></div>
                                </div>
                                <div style="margin-top: 5px; text-align: right; font-size: 0.8rem; font-weight: 600;">${record.confidence || 0}%</div>
                                
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                                    <button class="btn btn-outline" style="width: 100%; font-size: 0.9rem; padding: 8px;" onclick="openModal('${displayImgSrc}', '${record.disease || 'Analysis Result'}')" data-i18n="view_photo">View Photo</button>
                                </div>
                            </div>
                        `;
                        grid.appendChild(card);
                    });
                    
                    // Re-apply translations for dynamic content
                    applyTranslations(localStorage.getItem('language') || 'en');
                } else {
                    console.error('Failed to load history:', data.error);
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        function openModal(src, caption) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('fullImage');
            const captionText = document.getElementById('caption');
            modal.style.display = "block";
            modalImg.src = src;
            captionText.innerHTML = caption;
        }

        function closeModal() {
            document.getElementById('imageModal').style.display = "none";
        }

        window.onload = loadHistory;
    </script>
</body>
</html>
